name: Test and Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install linting dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pylint

      - name: Run pylint
        run: |
          pylint main.py --exit-zero || true
          echo "Pylint completed (exit-zero used to not fail workflow on warnings)"

      - name: Check for critical errors
        run: |
          pylint main.py --errors-only --fail-on=E || exit 1

  test-cache-linux:
    name: Test Cache Generation (Linux)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install tkinter (headless)
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-tk xvfb

      - name: Test cache generation
        run: |
          export DISPLAY=:99
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
          sleep 2
          timeout 30 python main.py --lang en --length 7 || true
          # Kill any remaining processes
          pkill -f "python main.py" || true
          pkill -f Xvfb || true

      - name: Verify cache was created
        run: |
          if [ ! -f "cache/en_7_utf-8.txt" ]; then
            echo "ERROR: Cache file was not created"
            exit 1
          fi
          echo "Cache file successfully created"
          ls -lh cache/en_7_utf-8.txt

      - name: Test cache loading (verify it's used on second run)
        run: |
          export DISPLAY=:99
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
          sleep 2
          # Get timestamp before running
          TIMESTAMP_BEFORE=$(stat -c %Y cache/en_7_utf-8.txt)
          timeout 30 python main.py --lang en --length 7 || true
          pkill -f "python main.py" || true
          pkill -f Xvfb || true
          # Verify cache file wasn't regenerated (same timestamp means it was reused)
          TIMESTAMP_AFTER=$(stat -c %Y cache/en_7_utf-8.txt)
          if [ "$TIMESTAMP_BEFORE" != "$TIMESTAMP_AFTER" ]; then
            echo "WARNING: Cache file timestamp changed, may have been regenerated"
          fi

  test-cache-windows:
    name: Test Cache Generation (Windows)
    if: ${{ github.actor != 'nektos/act' }}
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Test cache generation
        shell: powershell
        run: |
          Write-Host "Starting application in background..."
          $proc = Start-Process python -ArgumentList "main.py --lang en --length 7" -PassThru -WindowStyle Hidden
          Write-Host "Waiting for cache generation..."
          $cacheFile = "cache\en_7_utf-8.txt"
          $timeout = 30
          $elapsed = 0
          $interval = 1
          while (-not (Test-Path $cacheFile) -and $elapsed -lt $timeout) {
            Start-Sleep -Seconds $interval
            $elapsed += $interval
          }
          Write-Host "Stopping application..."
          if (-not $proc.HasExited) {
            Stop-Process -Id $proc.Id -Force -ErrorAction SilentlyContinue
          }
          Start-Sleep -Seconds 1

      - name: Verify cache was created
        shell: cmd
        run: |
          if not exist cache\en_7_utf-8.txt (
            echo ERROR: Cache file was not created
            exit /b 1
          )
          echo Cache file successfully created
          dir cache\en_7_utf-8.txt

  build-linux:
    name: Build Executable (Linux)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install tkinter (for build)
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-tk

      - name: Make build script executable
        run: |
          chmod +x build_exe.sh

      - name: Build executable
        run: |
          ./build_exe.sh

  build-windows:
    name: Build Executable (Windows)
    if: ${{ github.actor != 'nektos/act' }}
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build executable
        shell: cmd
        run: |
          .\build_exe.bat
